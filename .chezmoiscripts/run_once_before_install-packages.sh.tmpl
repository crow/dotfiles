#!/bin/bash

{{ if eq .chezmoi.os "darwin" -}}

# Install Homebrew if not present (critical)
if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || { echo "Homebrew install failed"; exit 1; }
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install age if not present (critical — needed for decryption)
if ! command -v age &>/dev/null; then
    echo "Installing age..."
    brew install age || { echo "age install failed"; exit 1; }
fi

# Install fzf if not present (non-critical)
if ! command -v fzf &>/dev/null; then
    echo "Installing fzf..."
    brew install fzf || echo "fzf install failed, skipping"
fi

# Install Oh My Zsh if not present (critical — shell config depends on it)
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended || { echo "Oh My Zsh install failed"; exit 1; }
fi

# Ensure nvm is loaded and Node 22 LTS is available
export NVM_DIR="$HOME/.nvm"
[ -s "/opt/homebrew/opt/nvm/nvm.sh" ] && . "/opt/homebrew/opt/nvm/nvm.sh"
if command -v nvm &>/dev/null; then
    if ! nvm ls 22 &>/dev/null; then
        echo "Installing Node 22 LTS via nvm..."
        nvm install 22 || echo "nvm install 22 failed, skipping"
    fi
    nvm alias default 22 2>/dev/null
fi

# Install Claude Code CLI via brew if not present
if ! command -v claude &>/dev/null; then
    echo "Installing Claude Code..."
    brew install claude-code || echo "claude-code install failed, skipping"
fi

{{ end -}}
