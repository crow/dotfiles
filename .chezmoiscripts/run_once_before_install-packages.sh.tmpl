#!/bin/bash

{{ if eq .chezmoi.os "darwin" -}}

# Install Homebrew if not present (critical)
if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || { echo "Homebrew install failed"; exit 1; }
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install age if not present (critical — needed for decryption)
if ! command -v age &>/dev/null; then
    echo "Installing age..."
    brew install age || { echo "age install failed"; exit 1; }
fi

# Install fzf if not present (non-critical)
if ! command -v fzf &>/dev/null; then
    echo "Installing fzf..."
    brew install fzf || echo "fzf install failed, skipping"
fi

# Install Oh My Zsh if not present (critical — shell config depends on it)
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended || { echo "Oh My Zsh install failed"; exit 1; }
fi

# Ensure node@22 (LTS) is installed and linked
if ! brew list node@22 &>/dev/null; then
    echo "Installing node@22..."
    brew install node@22 || echo "node@22 install failed, skipping"
fi
# Unlink any newer node and link node@22
if command -v node &>/dev/null && [[ "$(node --version)" != v22.* ]]; then
    echo "Linking node@22 (LTS) over $(node --version)..."
    brew unlink node 2>/dev/null
    brew link node@22 --force --overwrite 2>/dev/null
fi

# Install Claude Code CLI via brew if not present
if ! command -v claude &>/dev/null; then
    echo "Installing Claude Code..."
    brew install claude-code || echo "claude-code install failed, skipping"
fi

{{ end -}}
